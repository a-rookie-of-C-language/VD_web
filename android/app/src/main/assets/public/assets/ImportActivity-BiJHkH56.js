import{d as Q,u as X,r as u,a as Y,g as Z,o as ee,E as p,b as te,q as le,s as ae,c as g,e as t,i as r,w as l,f as s,h as d,F as z,j as D,k as E,l as y,p as oe,v as ne,m,t as se,n as ie,_ as re}from"./index-W60BvozO.js";const ue={class:"import-activity-page"},de={class:"content-container"},ce=["src"],pe={class:"participants-section"},me=Q({__name:"ImportActivity",setup(fe){const b=te(),f=X(),w=f.role,I=f.studentNo,x=u(),C=u("right"),a=Y({name:"",type:"",description:"",coverImage:null,duration:0,participants:[]}),N=u([]),h=u(!1),c=u([]),v=u(!1),V=u(""),F=Z(),L={name:[{required:!0,message:"请输入活动名称",trigger:"blur"}],type:[{required:!0,message:"请选择活动类型",trigger:"change"}],description:[{required:!0,message:"请输入活动描述",trigger:"blur"}],duration:[{required:!0,message:"请输入志愿时长",trigger:"change"}]},U=()=>{C.value=window.innerWidth<=768?"top":"right"};ee(async()=>{U(),window.addEventListener("resize",U),f.currentUser||await f.loadUserInfo(),w.value!=="functionary"&&w.value!=="admin"&&w.value!=="superAdmin"&&(p.warning("仅负责人或管理员可以导入活动"),await b.push("/activities")),M()}),le(()=>{window.removeEventListener("resize",U)});const M=async()=>{h.value=!0;try{N.value=await ae.getAllUsers()}catch(n){console.error(n)}finally{h.value=!1}},T=n=>{if(n.raw){const e=new FileReader;e.onload=_=>{V.value=String(_.target?.result||"")},e.readAsDataURL(n.raw),a.coverImage=n.raw}},j=n=>n.type.startsWith("image/")?n.size/1024/1024>20?(p.error("图片大小不能超过 20MB!"),!1):!0:(p.error("只能上传图片文件!"),!1),O=n=>{c.value=[n]},W=()=>{c.value=[]},$=async()=>{x.value&&await x.value.validate(async n=>{if(n){if(a.participants.length===0&&c.value.length===0){p.warning("请选择参与人员或上传Excel名单");return}v.value=!0;try{const e={functionary:I.value,name:a.name,type:a.type,description:a.description,endTime:new Date().toISOString(),duration:a.duration,participants:a.participants,coverFile:a.coverImage,file:c.value.length>0?c.value[0].raw:void 0};await ie.importActivity(e),p.success("活动导入成功!"),b.push("/activities")}catch(e){console.error("Failed to import activity:",e),p.error(e.message||"导入活动失败")}finally{v.value=!1}}})},P=()=>{b.back()};return(n,e)=>{const _=s("el-card"),A=s("el-divider"),k=s("el-input"),i=s("el-form-item"),B=s("el-option"),R=s("el-select"),G=s("el-icon"),q=s("el-upload"),H=s("el-input-number"),J=s("el-alert"),S=s("el-button"),K=s("el-form");return d(),g("div",ue,[t(_,{class:"page-header"},{default:l(()=>[...e[5]||(e[5]=[r("h1",{class:"page-title"},"后台导入活动",-1),r("p",{class:"subtitle"},"仅限负责人或管理员使用，可导入已有活动数据",-1)])]),_:1}),r("div",de,[t(_,null,{default:l(()=>[t(K,{ref_key:"formRef",ref:x,model:a,rules:L,"label-width":"120px","label-position":C.value},{default:l(()=>[t(A,{"content-position":"left"},{default:l(()=>[...e[6]||(e[6]=[r("span",{class:"section-title"},"基本信息",-1)])]),_:1}),t(i,{label:"活动名称",prop:"name"},{default:l(()=>[t(k,{modelValue:a.name,"onUpdate:modelValue":e[0]||(e[0]=o=>a.name=o),placeholder:"请输入活动名称",clearable:""},null,8,["modelValue"])]),_:1}),t(i,{label:"活动类型",prop:"type"},{default:l(()=>[t(R,{modelValue:a.type,"onUpdate:modelValue":e[1]||(e[1]=o=>a.type=o),placeholder:"请选择活动类型",clearable:"",style:{width:"100%"}},{default:l(()=>[(d(!0),g(z,null,D(y(F),o=>(d(),E(B,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(i,{label:"负责人(学号)"},{default:l(()=>[t(k,{"model-value":y(I),disabled:""},null,8,["model-value"])]),_:1}),t(i,{label:"活动描述",prop:"description"},{default:l(()=>[t(k,{modelValue:a.description,"onUpdate:modelValue":e[2]||(e[2]=o=>a.description=o),type:"textarea",rows:4,placeholder:"请输入活动详细描述"},null,8,["modelValue"])]),_:1}),t(i,{label:"封面图片"},{default:l(()=>[t(q,{class:"cover-uploader","auto-upload":!1,"show-file-list":!1,"on-change":T,"before-upload":j,accept:"image/*"},{default:l(()=>[V.value?(d(),g("img",{key:0,src:V.value,class:"cover-image",alt:""},null,8,ce)):(d(),E(G,{key:1,class:"cover-uploader-icon"},{default:l(()=>[t(y(oe))]),_:1}))]),_:1}),e[7]||(e[7]=r("div",{class:"upload-tip"},"支持 jpg、png 格式,大小不超过 20MB",-1))]),_:1}),t(i,{label:"志愿时长",prop:"duration"},{default:l(()=>[t(H,{modelValue:a.duration,"onUpdate:modelValue":e[3]||(e[3]=o=>a.duration=o),min:.5,step:.5,style:{width:"100%","max-width":"200px"}},null,8,["modelValue"])]),_:1}),t(A,{"content-position":"left"},{default:l(()=>[...e[8]||(e[8]=[r("span",{class:"section-title"},"参与人员",-1)])]),_:1}),r("div",pe,[t(J,{title:"请选择参与人员或上传Excel名单（两者可同时使用）",type:"info",closable:!1,"show-icon":"",class:"mb-4"}),t(i,{label:"手动选择"},{default:l(()=>[t(R,{modelValue:a.participants,"onUpdate:modelValue":e[4]||(e[4]=o=>a.participants=o),multiple:"",filterable:"",placeholder:"请搜索并选择参与人员",style:{width:"100%"},loading:h.value},{default:l(()=>[(d(!0),g(z,null,D(N.value,o=>(d(),E(B,{key:o.studentNo,label:`${o.username} (${o.studentNo})`,value:o.studentNo},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),t(i,{label:"Excel导入"},{default:l(()=>[t(q,{class:"excel-uploader",action:"#","auto-upload":!1,limit:1,accept:".xlsx, .xls","file-list":c.value,"on-change":O,"on-remove":W},{tip:l(()=>[...e[10]||(e[10]=[r("div",{class:"el-upload__tip"},[m(" 仅需包含一列："),r("b",null,"学号"),m("。支持 .xlsx, .xls 格式。 ")],-1)])]),default:l(()=>[t(S,{type:"primary",icon:y(ne)},{default:l(()=>[...e[9]||(e[9]=[m("上传名单文件",-1)])]),_:1},8,["icon"])]),_:1},8,["file-list"])]),_:1})]),t(i,{class:"form-actions"},{default:l(()=>[t(S,{type:"primary",loading:v.value,onClick:$,class:"action-btn"},{default:l(()=>[m(se(v.value?"导入中...":"确认导入"),1)]),_:1},8,["loading"]),t(S,{onClick:P,class:"action-btn"},{default:l(()=>[...e[11]||(e[11]=[m("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model","label-position"])]),_:1})])])}}}),_e=re(me,[["__scopeId","data-v-3504addd"]]);export{_e as default};
