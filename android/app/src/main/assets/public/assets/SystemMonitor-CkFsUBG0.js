import{W as E,d as Z,r as i,x as J,o as ee,c as g,i as e,e as s,w as o,f as p,E as te,s as ae,h as d,F as C,j as A,k as V,l as N,J as se,t as n,R as le,X as oe,S as ne,B as K,K as re,C as ie,Y as T,m as B,_ as de}from"./index-W60BvozO.js";const I="http://localhost:8080/api",$={async getFilterOptions(){const b=localStorage.getItem("token");try{return(await E.get(`${I}/monitoring/filters`,{headers:{Authorization:`Bearer ${String(b||"")}`}})).data.data}catch(c){return console.warn("Failed to fetch filters from backend, returning empty.",c),{colleges:[],grades:[],clazzes:[]}}},async getUserStats(b){const c=localStorage.getItem("token");return(await E.get(`${I}/monitoring/user-stats`,{params:b,headers:{Authorization:`Bearer ${String(c||"")}`}})).data.data},async getDashboardData(b="monthly",c={}){const f=localStorage.getItem("token"),u={timeRange:b,...c};return Object.keys(u).forEach(h=>{(u[h]===void 0||u[h]==="")&&delete u[h]}),(await E.get(`${I}/monitoring/dashboard`,{params:u,headers:{Authorization:`Bearer ${String(f||"")}`}})).data.data}},ce={class:"monitor-page"},ue={class:"header"},ve={class:"header-controls"},pe={class:"card-content"},_e={class:"icon-wrapper blue"},ge={class:"info"},fe={class:"value"},he={class:"card-content"},me={class:"icon-wrapper orange"},be={class:"info"},we={class:"value"},ze={class:"sub-value"},ye={class:"card-content"},ke={class:"icon-wrapper green"},Se={class:"info"},Ue={class:"value"},De={class:"sub-value"},xe={class:"card-content"},Ce={class:"icon-wrapper purple"},Ae={class:"info"},Ve={class:"value"},Ne={class:"visible-xs-only mobile-user-list"},Be={class:"user-card-header"},Fe={class:"user-name"},Me={class:"user-no"},Oe={class:"user-card-body"},Pe={class:"info-row"},Ee={class:"info-row"},Ie={class:"info-row"},$e={class:"info-row stats-row"},Le={class:"stat-item"},je={class:"stat-val"},Re={class:"stat-item"},Ge={class:"stat-val highlight"},Je={key:0,class:"pagination-container"},Ke=Z({__name:"SystemMonitor",setup(b){const c=i(""),f=i(""),u=i(""),S=i([]),h=i([]),F=i([]),U=i(1),M=i(10),O=i(0),v=i({totalUsers:0,totalActivities:0,totalDuration:0,totalParticipants:0,completedActivities:0,averageDuration:0,newActivities:0,activeUsers:0}),L=i([]),j=i(new Map),P=i([]),D=i(!1),W=J(()=>v.value.totalUsers?(v.value.totalActivities/v.value.totalUsers).toFixed(1):0),R=J(()=>P.value.length>0?P.value:L.value.map(l=>{const t=j.value.get(l.studentNo);return{...l,clazz:t?.clazz||"-",grade:t?.grade||"-",college:t?.college||"-",activityCount:0,totalDuration:l.hours}})),y=async()=>{D.value=!0;try{const l=await $.getDashboardData("yearly",{clazz:c.value,grade:f.value,college:u.value});v.value=l.overview,L.value=l.topUsers;try{const t=await $.getUserStats({page:U.value,pageSize:M.value,clazz:c.value,grade:f.value,college:u.value});t&&t.records&&(P.value=t.records,O.value=t.total)}catch(t){console.warn("New user stats API failed, using fallback",t)}}catch(l){console.error(l),te.error("加载监控数据失败")}finally{D.value=!1}},X=async()=>{try{const l=await $.getFilterOptions();if(l&&(l.clazzes.length||l.grades.length||l.colleges.length)){S.value=l.clazzes,h.value=l.grades,F.value=l.colleges;return}const t=await ae.getAllUsers(),w=new Set,z=new Set,m=new Set;t.forEach(r=>{r.studentNo&&j.value.set(r.studentNo,r),r.clazz&&w.add(r.clazz),r.grade&&z.add(r.grade),r.college&&m.add(r.college)}),S.value=Array.from(w).sort(),h.value=Array.from(z).sort(),F.value=Array.from(m).sort()}catch(l){console.error("Failed to fetch filter options",l)}},Y=l=>{U.value=l,y()};return ee(()=>{X(),y()}),(l,t)=>{const w=p("el-option"),z=p("el-select"),m=p("el-icon"),r=p("el-card"),x=p("el-col"),q=p("el-row"),_=p("el-table-column"),H=p("el-table"),Q=p("el-pagination"),G=ie("loading");return d(),g("div",ce,[e("div",ue,[t[5]||(t[5]=e("h1",{class:"title"},"系统监控大屏",-1)),e("div",ve,[s(z,{modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=a=>c.value=a),placeholder:"班级筛选",clearable:"",size:"default",onChange:y,style:{width:"150px"}},{default:o(()=>[(d(!0),g(C,null,A(S.value,a=>(d(),V(w,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(z,{modelValue:f.value,"onUpdate:modelValue":t[1]||(t[1]=a=>f.value=a),placeholder:"年级筛选",clearable:"",size:"default",onChange:y,style:{width:"150px"}},{default:o(()=>[(d(!0),g(C,null,A(h.value,a=>(d(),V(w,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(z,{modelValue:u.value,"onUpdate:modelValue":t[2]||(t[2]=a=>u.value=a),placeholder:"学院筛选",clearable:"",size:"default",onChange:y,style:{width:"180px"}},{default:o(()=>[(d(!0),g(C,null,A(F.value,a=>(d(),V(w,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),s(q,{gutter:20,class:"mb-4"},{default:o(()=>[s(x,{span:6,xs:12},{default:o(()=>[s(r,{shadow:"hover",class:"data-card"},{default:o(()=>[e("div",pe,[e("div",_e,[s(m,null,{default:o(()=>[s(N(se))]),_:1})]),e("div",ge,[t[6]||(t[6]=e("div",{class:"label"},"人数",-1)),e("div",fe,n(v.value.totalUsers),1)])])]),_:1})]),_:1}),s(x,{span:6,xs:12},{default:o(()=>[s(r,{shadow:"hover",class:"data-card"},{default:o(()=>[e("div",he,[e("div",me,[s(m,null,{default:o(()=>[s(N(le))]),_:1})]),e("div",be,[t[7]||(t[7]=e("div",{class:"label"},"总志愿时长",-1)),e("div",we,n(v.value.totalDuration)+"h",1),e("div",ze,"平均: "+n((v.value.totalDuration/(v.value.totalUsers||1)).toFixed(1))+"h/人",1)])])]),_:1})]),_:1}),s(x,{span:6,xs:12},{default:o(()=>[s(r,{shadow:"hover",class:"data-card"},{default:o(()=>[e("div",ye,[e("div",ke,[s(m,null,{default:o(()=>[s(N(oe))]),_:1})]),e("div",Se,[t[8]||(t[8]=e("div",{class:"label"},"总参加活动数",-1)),e("div",Ue,n(v.value.totalActivities),1),e("div",De,"平均: "+n(W.value)+"次/人",1)])])]),_:1})]),_:1}),s(x,{span:6,xs:12},{default:o(()=>[s(r,{shadow:"hover",class:"data-card"},{default:o(()=>[e("div",xe,[e("div",Ce,[s(m,null,{default:o(()=>[s(N(ne))]),_:1})]),e("div",Ae,[t[9]||(t[9]=e("div",{class:"label"},"参与人次",-1)),e("div",Ve,n(v.value.totalParticipants),1)])])]),_:1})]),_:1})]),_:1}),s(r,{shadow:"hover",class:"mb-4"},{header:o(()=>[...t[10]||(t[10]=[e("div",{class:"card-header"},[e("span",null,"用户详细数据")],-1)])]),default:o(()=>[K((d(),V(H,{data:R.value,stripe:"",style:{width:"100%"},class:"hidden-xs-only"},{default:o(()=>[s(_,{prop:"rank",label:"排名",width:"80",align:"center"},{default:o(({row:a,$index:k})=>[e("div",{class:T(["rank-badge","rank-"+(a.rank||k+1)])},n(a.rank||k+1),3)]),_:1}),s(_,{prop:"name",label:"姓名"}),s(_,{prop:"studentNo",label:"学号"}),s(_,{prop:"college",label:"学院"}),s(_,{prop:"grade",label:"年级"}),s(_,{prop:"clazz",label:"班级"}),s(_,{prop:"activityCount",label:"参加活动数",align:"center"}),s(_,{prop:"totalDuration",label:"志愿时长 (小时)",align:"right",sortable:""},{default:o(({row:a})=>[B(n(a.totalDuration),1)]),_:1})]),_:1},8,["data"])),[[G,D.value]]),K((d(),g("div",Ne,[(d(!0),g(C,null,A(R.value,(a,k)=>(d(),g("div",{key:a.studentNo,class:"mobile-user-card"},[e("div",Be,[e("div",{class:T(["rank-badge","rank-"+(a.rank||k+1)])},n(a.rank||k+1),3),e("span",Fe,n(a.name),1),e("span",Me,n(a.studentNo),1)]),e("div",Oe,[e("div",Pe,[t[11]||(t[11]=e("span",{class:"label"},"学院:",-1)),B(" "+n(a.college),1)]),e("div",Ee,[t[12]||(t[12]=e("span",{class:"label"},"年级:",-1)),B(" "+n(a.grade),1)]),e("div",Ie,[t[13]||(t[13]=e("span",{class:"label"},"班级:",-1)),B(" "+n(a.clazz),1)]),e("div",$e,[e("div",Le,[e("span",je,n(a.activityCount),1),t[14]||(t[14]=e("span",{class:"stat-lbl"},"活动数",-1))]),e("div",Re,[e("span",Ge,n(a.totalDuration),1),t[15]||(t[15]=e("span",{class:"stat-lbl"},"志愿时长",-1))])])])]))),128))])),[[G,D.value]]),O.value>0?(d(),g("div",Je,[s(Q,{"current-page":U.value,"onUpdate:currentPage":t[3]||(t[3]=a=>U.value=a),"page-size":M.value,"onUpdate:pageSize":t[4]||(t[4]=a=>M.value=a),total:O.value,layout:"total, prev, pager, next",onCurrentChange:Y},null,8,["current-page","page-size","total"])])):re("",!0)]),_:1})])}}}),We=de(Ke,[["__scopeId","data-v-bf35b747"]]);export{We as default};
